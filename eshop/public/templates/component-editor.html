<div data-component="form" data-title="@(Select widget)" data-component-path="cmseditor.window" data-if="value === 'widgets'" data-width="500px" data-component-id="cmseditor_widgets">
	<div class="padding">
		<div data-component="repeater-group" data-component-path="cmseditor.widgets2" data-group="category">
			<script type="text/html">
				<div class="pages-editor-widget" data-id="{{ id }}" data-template="{{ istemplate }}" data-name="{{ name }}"><span class="fa fa-{{ if icon }}{{ icon }}{{ else if istemplate }}code{{ else }}plug{{ fi }} w18"></span> {{ name }}</div>
			</script>
			<script type="text/html">
				<br />
				<div class="silver fs11" style="margin-bottom:5px">{{ category }}</div>
			</script>
		</div>
	</div>
	<div class="ui-form-buttons">
		<button name="cancel" style="width:100%">@(Cancel)</button>
	</div>
</div>

<div data-component="form" data-title="@(Picture editor)" data-component-path="cmseditor.window" data-if="value === 'picture'" data-width="1100px" data-component-id="cmseditor_picture">
	<div class="padding">
		<div data-component="crop" data-component-path="cmseditor.crop.url" data-width="700" data-height="500" data-component-id="cmseditor.crop"></div>
		<div class="row">
			<br />
			<div class="col-md-12 m">
				<div data-component="textbox" data-component-path="cmseditor.crop.alt" data-required="true">@(Picture description)</div>
			</div>
			<div class="col-md-12" data-component="visible" data-component-path="cmseditor.crop.href" data-if="value && value.length > 0">
				<div data-component="dropdown" data-component-path="cmseditor.crop.href" class="m" data-icon="fa-sitemap" data-source="pages.sitemap" data-source-key="name" data-source-value="url" data-empty="">@(URL according to the sitemap)</div>
				<div data-component="textbox" data-component-path="cmseditor.crop.href">@(URL address)</div>
			</div>
		</div>
	</div>
	<div class="ui-form-buttons">
		<div data-component="validation" data-component-path="cmseditor.crop">
			<button name="submit">@(SUBMIT)</button>
		</div>
		<button name="cancel">@(Cancel)</button>
	</div>
</div>

<div data-component="form" data-title="@(Link editor)" data-component-path="cmseditor.window" data-if="value === 'link'" data-width="450px" data-component-id="cmseditor_link">
	<div class="padding">
		<div class="row">
			<div class="col-md-12">
				<div class="silver"><span class="fa fa-link"></span> @(<b>Change the target URL address</b> and other settings for the selected link.)</div>
				<hr />
				<div data-component="fileupload" data-component-path="cmseditor.link.file" data-placeholder="@(Browse device)" data-error-large="@(The uploaded file is too large.)" data-icon="fa-file" class="m" data-singlefile="true">@(Upload file)</div>
				<div data-component="dropdown" data-component-path="cmseditor.link.href" class="m" data-icon="fa-sitemap" data-source="pages.sitemap" data-source-key="name" data-source-value="url" data-empty="">@(URL according to the sitemap)</div>
				<div data-component="textbox" data-component-path="cmseditor.link.href" data-required="true" class="m" data-icon="fa-globe">@(URL address)</div>
				<div data-component="dropdown" data-component-path="cmseditor.link.target" data-required="true" data-options="@(Current tab or window)|_self;@(New tab or window)|_blank" class="m">@(Target)</div>
				<div data-component="textbox" data-component-path="cmseditor.link.title" data-icon="fa-info-circle">@(Title)</div>
			</div>
		</div>
	</div>
	<div class="ui-form-buttons">
		<div data-component="validation" data-component-path="cmseditor.link">
			<button name="submit">@(SUBMIT)</button>
		</div>
		<button name="cancel">@(Cancel)</button>
	</div>
</div>

<div data-component="form" data-title="@(Attributes editor)" data-component-path="cmseditor.window" data-if="value === 'attribute'" data-width="450px" data-component-id="cmseditor_attribute">
	<div class="padding npb">
		<div class="row">
			<div class="col-md-12">
				<div data-component="textbox" data-component-path="cmseditor.attribute.title" class="m">@(Title)</div>
				<div data-component="textbox" data-component-path="cmseditor.attribute.id" class="m">@(ID)</div>
				<div data-component="textbox" data-component-path="cmseditor.attribute.cls" class="m">@(Class name)</div>
			</div>
		</div>
	</div>
	<div data-component="visible" data-component-path="cmseditor.attribute.isimage" data-if="value === true">
		<hr />
		<div class="padding npt">
			<div class="help m"><span class="fa fa-photo"></span> @(Image settings)</div>

			<div class="row">
				<div class="col-md-12">
					<div data-component="textbox" data-component-path="cmseditor.attribute.alt" class="m">@(Alternate text)</div>
				</div>
			</div>

			<div class="row">
				<div class="col-md-4">
					<div data-component="textbox" data-component-path="cmseditor.attribute.datawidth" class="m" data-maxlenght="4" data-placeholder="120" data-align="center">@(Width)</div>
				</div>
				<div class="col-md-4">
					<div data-component="textbox" data-component-path="cmseditor.attribute.dataheight" class="m" data-maxlenght="4" data-placeholder="120" data-align="center">@(Height)</div>
				</div>
				<div class="col-md-4">
					<div data-component="textbox" data-component-path="cmseditor.attribute.datasize" class="m" data-maxlenght="4" data-placeholder="0%" data-align="center">@(Percentage)</div>
				</div>
			</div>
		</div>
	</div>
	<div class="ui-form-buttons">
		<button name="submit">@(SUBMIT)</button>
		<button name="cancel">@(Cancel)</button>
	</div>
</div>

<div data-component="form" data-title="@(Icon editor)" data-component-path="cmseditor.window" data-if="value === 'icon'" data-width="700px" data-component-id="cmseditor_icon">
	<div class="padding">
		<div class="row font-awesome-editor" id="cmseditoricons"></div>
	</div>
	<div class="ui-form-buttons">
		<button name="cancel" style="width:100%">@(Cancel)</button>
	</div>
</div>

<div data-component="form" data-title="@(Widget settings)" data-component-path="cmseditor.window" data-if="value === 'widget'" data-width="500px" data-component-id="cmseditor_widget">
	<div class="padding">
		<div class="row">
			<div class="col-md-12">
				<div class="silver"><span class="fa fa-plug"></span> @(Add a custom settings for the selected widget. The setting affects behavior of the widget.)</div>
				<hr />
				<div data-component="textarea" data-component-path="cmseditor.widget.settings" data-icon="fa-cog" data-height="150px" class="ui-textarea-code">@(Settings)</div>
			</div>
		</div>
	</div>
	<div class="ui-form-buttons">
		<div data-component="validation" data-component-path="cmseditor.widget">
			<button name="submit">@(SUBMIT)</button>
		</div>
		<button name="cancel">@(Cancel)</button>
	</div>
</div>

<div data-component="form" data-title="@(Source code editor)" data-component-path="cmseditor.window" data-if="value === 'source'" data-width="1100px" data-component-id="cmseditor_source">
	<div class="padding">
		<div class="row">
			<div class="col-md-12">
				<div data-component="codemirror" data-component-path="cmseditor.source" data-icon="fa-code" data-height="400px" data-required="true" class="ui-textarea-code">@(HTML)</div>
			</div>
		</div>
	</div>
	<div class="ui-form-buttons">
		<div data-component="validation" data-component-path="cmseditor.source">
			<button name="submit">@(SUBMIT)</button>
		</div>
		<button name="cancel">@(Cancel)</button>
	</div>
</div>

<input type="file" class="hidden" id="cmseditor_inlineupload" accept="image/*" data-error-large="@(The uploaded file is too large.)" />

<script>

	// A helper object
	var cmseditor = {};
	cmseditor.window = '';
	cmseditor.link = {};
	cmseditor.attribute = {};
	cmseditor.crop = {};
	cmseditor.widget = {};
	cmseditor.widget.settings = {};
	cmseditor.source = '';
	cmseditor.html = {};
	cmseditor.icons = 'glass,music,search,envelope-o,heart,star,star-o,user,film,th-large,th,th-list,check,times,search-plus,search-minus,power-off,signal,cog,trash-o,home,file-o,clock-o,road,download,arrow-circle-o-down,arrow-circle-o-up,inbox,play-circle-o,repeat,refresh,list-alt,lock,flag,headphones,volume-off,volume-down,volume-up,qrcode,barcode,tag,tags,book,bookmark,print,camera,font,bold,italic,text-height,text-width,align-left,align-center,align-right,align-justify,list,dedent,outdent,indent,video-camera,photo,pencil,map-marker,adjust,tint,edit,share-square-o,check-square-o,arrows,step-backward,fast-backward,backward,play,pause,stop,forward,fast-forward,step-forward,eject,chevron-left,chevron-right,plus-circle,minus-circle,times-circle,check-circle,question-circle,info-circle,crosshairs,times-circle-o,check-circle-o,ban,arrow-left,arrow-right,arrow-up,arrow-down,share,expand,compress,plus,minus,asterisk,gift,leaf,fire,eye,eye-slash,warning,exclamation-triangle,plane,calendar,random,comment,magnet,chevron-up,chevron-down,retweet,shopping-cart,folder,folder-open,arrows-v,arrows-h,bar-chart,twitter-square,facebook-square,camera-retro,key,cogs,comments,thumbs-o-up,thumbs-o-down,star-half,heart-o,sign-out,linkedin-square,thumb-tack,external-link,sign-in,trophy,github-square,upload,lemon-o,phone,square-o,bookmark-o,phone-square,twitter,facebook,github,unlock,credit-card,rss,hdd-o,bullhorn,bell,certificate,hand-o-right,hand-o-left,hand-o-up,hand-o-down,arrow-circle-left,arrow-circle-right,arrow-circle-up,arrow-circle-down,globe,wrench,tasks,filter,briefcase,arrows-alt,users,link,cloud,flask,cut,copy,files-o,paperclip,save,square,navicon,list-ul,list-ol,strikethrough,underline,table,magic,truck,pinterest,pinterest-square,google-plus-square,google-plus,money,caret-down,caret-up,caret-left,caret-right,columns,sort,sort-desc,sort-asc,envelope,linkedin,undo,gavel,dashboard,comment-o,comments-o,bolt,sitemap,umbrella,paste,lightbulb-o,exchange,cloud-download,cloud-upload,user-md,stethoscope,suitcase,bell-o,coffee,cutlery,file-text-o,building-o,hospital-o,ambulance,medkit,fighter-jet,beer,h-square,plus-square,angle-double-left,angle-double-right,angle-double-up,angle-double-down,angle-left,angle-right,angle-up,angle-down,desktop,laptop,tablet,mobile,circle-o,quote-left,quote-right,spinner,circle,reply,github-alt,folder-o,folder-open-o,smile-o,frown-o,meh-o,gamepad,keyboard-o,flag-o,flag-checkered,terminal,code,reply-all,star-half-o,location-arrow,crop,code-fork,unlink,question,info,exclamation,superscript,subscript,eraser,puzzle-piece,microphone,microphone-slash,shield,calendar-o,fire-extinguisher,rocket,maxcdn,chevron-circle-left,chevron-circle-right,chevron-circle-up,chevron-circle-down,anchor,unlock-alt,bullseye,ellipsis-h,ellipsis-v,rss-square,play-circle,ticket,minus-square,minus-square-o,level-up,level-down,check-square,pencil-square,external-link-square,share-square,compass,toggle-down,toggle-up,toggle-right,gbp,usd,eur,rupee,jpy,rub,won,btc,file,file-text,sort-alpha-asc,sort-alpha-desc,sort-amount-asc,sort-amount-desc,sort-numeric-asc,sort-numeric-desc,thumbs-up,thumbs-down,youtube-square,youtube,xing,xing-square,youtube-play,dropbox,stack-overflow,instagram,flickr,adn,bitbucket,bitbucket-square,tumblr,tumblr-square,long-arrow-down,long-arrow-up,long-arrow-left,long-arrow-right,apple,windows,android,linux,dribbble,skype,foursquare,trello,female,male,gratipay,sun-o,moon-o,archive,bug,vk,weibo,renren,pagelines,stack-exchange,arrow-circle-o-right,arrow-circle-o-left,toggle-left,dot-circle-o,wheelchair,vimeo-square,try,plus-square-o,space-shuttle,slack,envelope-square,wordpress,openid,university,graduation-cap,yahoo,google,reddit,reddit-square,stumbleupon-circle,stumbleupon,delicious,digg,pied-piper,pied-piper-alt,drupal,joomla,language,fax,building,child,paw,spoon,cube,cubes,behance,behance-square,steam,steam-square,recycle,car,tree,spotify,deviantart,soundcloud,database,file-pdf-o,file-word-o,file-excel-o,file-powerpoint-o,file-image-o,file-zip-o,file-audio-o,file-video-o,file-code-o,vine,codepen,jsfiddle,support,circle-o-notch,ra,ge,git-square,git,hacker-news,tencent-weibo,qq,wechat,send,send-o,history,circle-thin,header,paragraph,sliders,share-alt,share-alt-square,bomb,futbol-o,tty,binoculars,plug,slideshare,twitch,yelp,newspaper-o,wifi,calculator,paypal,google-wallet,cc-visa,cc-mastercard,cc-discover,cc-amex,cc-paypal,cc-stripe,bell-slash,bell-slash-o,trash,copyright,at,eyedropper,paint-brush,birthday-cake,area-chart,pie-chart,line-chart,lastfm,lastfm-square,toggle-off,toggle-on,bicycle,bus,ioxhost,angellist,cc,shekel,meanpath,buysellads,connectdevelop,dashcube,forumbee,leanpub,sellsy,shirtsinbulk,simplybuilt,skyatlas,cart-plus,cart-arrow-down,diamond,ship,user-secret,motorcycle,street-view,heartbeat,venus,mars,mercury,intersex,transgender,transgender-alt,venus-double,mars-double,venus-mars,mars-stroke,mars-stroke-v,mars-stroke-h,neuter,genderless,facebook-official,pinterest-p,whatsapp,server,user-plus,user-times,bed,viacoin,train,subway,medium,yc,optin-monster,opencart,expeditedssl,battery-full,battery-three-quarters,battery-half,battery-quarter,battery-empty,mouse-pointer,i-cursor,object-group,object-ungroup,sticky-note,sticky-note-o,cc-jcb,cc-diners-club,clone,balance-scale,hourglass-o,hourglass-start,hourglass-half,hourglass-end,hourglass,hand-grab-o,hand-paper-o,hand-scissors-o,hand-lizard-o,hand-spock-o,hand-pointer-o,hand-peace-o,trademark,registered,creative-commons,gg,gg-circle,tripadvisor,odnoklassniki,odnoklassniki-square,get-pocket,wikipedia-w,safari,chrome,firefox,opera,internet-explorer,tv,contao,amazon,calendar-plus-o,calendar-minus-o,calendar-times-o,calendar-check-o,industry,map-pin,map-signs,map-o,map,commenting,commenting-o,houzz,vimeo,black-tie,fonticons';
	cmseditor.instance = null;
	cmseditor.widgets = []; // Contains all widgets
	cmseditor.widgets2 = []; // Contains all filtered widgets
	cmseditor.settings = []; // Contains all widgets settings

	setTimeout(function() {
		$('#cmseditor_inlineupload').on('change', function(e) {
			var data = new FormData();
			var files = e.target.files;
			var errmsg = $(this).attr('data-error-large');
			var loading = FIND('loading').show();
			data.append('file0', files[0]);
			this.value = '';
			jC.UPLOAD('{0}/upload/'.format(managerurl), data, function(response, err) {

				if (err) {
					loading.hide();
					var message = FIND('message');
					if (message)
						message.warning(errmsg);
					else
						alert(errmsg);
					return;
				}

				if (response && response.length) {
					cmseditor.instance.getTarget().attr('src', '/download/' + response[0]);
					cmseditor.instance.change(true);
				}

				loading.hide(500);
			});
		});
	}, 1000);

	// CMS EDITOR
	COMPONENT('editor', function() {

		var self = this;
		var target;
		var iframe;
		var width;
		var offsetter = '<span id="cmseditorheight"></span>';

		self.options = MAKE(function(options) {
			options.template = 'default';
		});

		self.readonly();

		self.make = function() {
			self.html('<iframe src="about:blank"></iframe>');
			iframe = self.find('iframe');
		};

		self.init = function() {
			if (!window.widgets)
				self.refreshWidgets();
			WATCH('widgets.grid', function(path, value, type) {
				var items = value && value.items ? value.items : [];
				cmseditor.widgets = items; // cache
				SET('cmseditor.widgets2', items);
			}, true);
		};

		self.save = function(callback, type) {
			var w = self.getWindow();
			if (w.$cmseditor_save)
				w.$cmseditor_save(type);
			if (w.COM)
				w.COM.emit('cmseditor.save', type);
			setTimeout(callback, 1000);
		};

		self.write = function(content) {

			var frm = iframe.get(0).contentWindow;
			if (!frm)
				return;

			frm.document.open('text/html', 'replace');

			if (!content) {
				frm.document.write('<html><head></head><body style="color:gray;text-align:center;padding:90px 0 0;margin:0;font-family:Arial;font-size:11px;color:#ADADAD;line-height:16px">@(<b>WITHOUT CONTENT</b><br />Choose the template for content editing.)</body></html>');
				frm.document.close();
				iframe.css({ height: 'auto' });
				return;
			}

			frm.document.write(content.replace('</body>', offsetter + '</body>'));
			frm.document.close();
			frm.$cmseditor = true;

			iframe.css({ height: 'auto' });

			setTimeout(function() {
				self.setEvents();
				self.resize(10);
			}, 500);
		};

		self.setTemplate = function(name) {
			self.options.template = name;
		};

		self.setSettings = function(settings) {
			cmseditor.settings = settings;
		};

		self.refreshWidgets = function() {
			AJAX('GET {0}/api/widgets/'.format(managerurl), function(response) {
				if (isError(arguments))
					return;
				response.sort(FN('(a,b) => a.name.localeCompare(b.name)'));
				SET('cmseditor.widgets', response);
			});
		};

		self.getToolbar = function() {
			return self.doFind('#CMS_panel');
		};

		self.getContents = function() {
			return iframe.contents();
		};

		self.doFind = function(selector) {
			return iframe.contents().find(selector);
		};

		self.getDocument = function() {
			return this.getWindow().document;
		};

		self.getWindow = function() {
			return iframe.get(0).contentWindow;
		};

		self.getTarget = function() {
			return target;
		};

		self.getParent = function(cls, max) {

			if (target.hasClass(cls))
				return target;

			var parent = target.parent();
			if (!max)
				max = 20;

			for (var i = 0; i < max; i++) {
				if (parent.hasClass(cls))
					return parent;
				parent = parent.parent();
			}

			return null;
		};

		self.getParentElement = function(name) {
			if (target.get(0).nodeName === name)
				return target;
			var parent = target.parent();
			for (var i = 0; i < 20; i++) {
				var el = parent.get(0);
				if (!el)
					break;
				if (el.nodeName === name)
					return parent;
				parent = parent.parent();
			}
			return null;
		};

		self.state = function(type, who) {
			if (who === 2)
				self.resize(true);
		};

		self.getWidgets = function() {
			var settings = [];
			var widgets = [];

			self.doFind('.CMS_widget').each(function() {
				var el = $(this);
				widgets.push(el.attr('data-id'));
				settings.push(el.find('pre').text());
			});

			return { widgets: widgets, settings: settings };
		};

		self.getPerex = function() {
			return self.doFind('.CMS_perex').html();
		};

		self.getKeywords = function() {

			var text = '';

			self.doFind('.CMS_search').each(function(index) {
				text += ' ' + this.innerText;
			});

			if (!text) {
				self.doFind('.CMS_edit').each(function(index) {
					text += ' ' + this.innerText;
				});
			}

			return find_keywords(text);
		};

		function find_keywords(content, alternative, count, max, min) {

			min = min || 2;
			count = count || 200;
			max = max || 20;

			var words = content.toLowerCase().match(/[a-ž]+/gi);

			if (words === null)
				words = [];

			var length = words.length;
			var dic = {};
			var counter = 0;

			for (var i = 0; i < length; i++) {
				var word = words[i].trim();

				if (word.length < min)
					continue;

				if (counter >= count)
					break;

				if (alternative)
					word = word.substring(0, (word.length / 100) * 80);

				if (word.length < min || word.length > max)
					continue;

				if (dic[word])
					dic[word]++;
				else
					dic[word] = 1;

				counter++;
			}

			var keys = Object.keys(dic);

			keys.sort(function(a, b) {

				var countA = dic[a];
				var countB = dic[b];

				if (countA > countB)
					return -1;

				if (countA < countB)
					return 1;

				return 0;
			});

			return keys.join(' ');
		}

		self.getPictures = function() {
			var pictures = [];
			self.doFind('img.CMS_edit').each(function() {
				var el = $(this);
				var url = el.attr('src');
				if (pictures.indexOf(url) !== -1)
					return;
				if (pictures.length < 5)
					pictures.push(url);
			});

			return pictures;
		};

		self.getSourceCode = function() {
			var content = self.getContents();
			content.find('[contenteditable]').removeAttr('contenteditable');
			content.find('.CMS_selected').removeClass('CMS_selected');
			return (content.find('#CMS').html() || '').trim().replace(offsetter, '');
		};

		self.getContent = function() {
			var content = self.getContents();
			content.find('[contenteditable]').removeAttr('contenteditable');
			content.find('.CMS_widget').html('');
			content.find('.CMS_selected').removeClass('CMS_selected');
			content.find('.CMS_edit:empty,.CMS_remove:empty,.CMS_widgets:empty').each(function() {
				if (this.nodeName === 'IMG')
					return;
				var cls = this.getAttribute('class');
				if (cls.indexOf('CMS_widget') === -1 && cls.indexOf('fa') === -1)
					$(this).remove();
			});
			return (content.find('#CMS').html() || '').trim().replace(offsetter, '');
		};

		self.setEvents = function() {

			var body = self.getContents();
			body.off('click');
			body.on('click', '.CMS_edit,.CMS_repeat,.CMS_remove,.CMS_widgets,.CMS_attribute', function(e) {

				e.preventDefault();
				e.stopPropagation();

				var el = $(this);

				if (target && this !== target.get(0)) {
					target.removeClass('CMS_selected');
					target.removeAttr('contenteditable');
					target = null;
				}

				if (target)
					return;

				var off = el.offset();
				var panel = self.getToolbar();
				var left = off.left;

				if (left + 270 > width)
					left = width - 270;

				panel.css({ left: left, top: off.top - panel.innerHeight() - 5 });

				// Firefox
				setTimeout(function() {
					panel.show();
				}, 100);

				var arr = el.attr('class').split(/\s+/);
				target = el;

				panel.find('span').each(function() {
					var el = $(this);
					var name = el.attr('data-name');

					if (name === 'hide')
						return;

					var disabled = arr.indexOf('CMS_' + name) === -1;

					if (disabled && name === 'attribute')
						disabled = arr.indexOf('CMS_edit') === -1;

					if (name === 'link')
						disabled = self.getParentElement('A') === null;

					// Are some widgets?
					if (name === 'widgets' && !disabled)
						disabled = cmseditor.widgets2.length === 0;

					if (name === 'edit' && target.hasClass('CMS_widget'))
						disabled = false;

					if (disabled && name === 'repeat')
						disabled = self.getParent('CMS_repeat') === null;

					if (disabled && name === 'remove')
						disabled = self.getParent('CMS_remove') === null;

					if (disabled && name === 'widgets')
						disabled = self.getParent('CMS_widgets', 5) === null;

					el.toggleClass('CMS_panel_disabled', disabled);
				});

				target.addClass('CMS_selected');
			});

			body.off('paste');
			body.on('paste', function(e) {
				e.preventDefault();
				e.stopPropagation();
				var text = e.originalEvent.clipboardData.getData('text/plain');
				if (target.hasClass('CMS_singleline'))
					text = text.replace(/\n\r/g, ' ');
				self.getDocument().execCommand('insertText', false, text);
			});

			body.unbind('keydown').on('keydown', function(e) {
				if (!target)
					return;

				if (e.keyCode === 13 && target.hasClass('CMS_singleline')) {
					e.preventDefault();
					return;
				}

				if (!e.metaKey && !e.ctrlKey)
					return;

				if (e.keyCode === 66) {
					// bold
					self.getDocument().execCommand('Bold', false, null);
					e.preventDefault();
					e.stopPropagation();
					return;
				}

				if (e.keyCode === 76) {

					// link
					e.preventDefault();
					e.stopPropagation();

					var url = '#' + Date.now();
					self.getDocument().execCommand('CreateLink', false, url);
					var tmp = self.getTarget().find('a[href="' + url + '"]');
					if (tmp.length === 0)
						return;

					tmp.attr('class', 'CMS_edit');
					target.removeAttr('contentEditable');
					target.removeClass('CMS_selected');
					target = tmp;
					target.data('temporary', true);

					cmseditor.link.file = '';
					cmseditor.link.href = '';
					cmseditor.link.target = '_blank';
					cmseditor.link.title = '';

					UPDATE('cmseditor.link', true);
					SET('cmseditor.window', 'link');
					return;
				}

				if (e.keyCode === 73) {
					// italic
					self.getDocument().execCommand('Italic', false, null);
					e.preventDefault();
					e.stopPropagation();
					return;
				}

				if (e.keyCode === 85) {
					// underline
					self.getDocument().execCommand('Underline', false, null);
					e.preventDefault();
					e.stopPropagation();
					return;
				}
			});

			body.on('click', 'a', function(e) {
				e.preventDefault();
			});

			body.find('#CMS_panel').on('click', 'span', function(e) {

				e.preventDefault();
				e.stopPropagation();

				var el = $(this);
				if (el.hasClass('CMS_panel_disabled'))
					return;

				var name = el.attr('data-name');
				switch (name) {

					case 'widgets':
						SET('cmseditor.window', 'widgets');
						return;

					case 'hide':
						self.getToolbar().hide();
						target.removeAttr('contentEditable');
						target.removeClass('CMS_selected');
						target = null;
						return;

					case 'attribute':
						var cls = target.attr('class').split(' ');
						var arr = [];

						cls.forEach(function(cls) {
							if (cls.substring(0, 4) !== 'CMS_')
								arr.push(cls);
						});

						cmseditor.attribute.isimage = target.get(0).nodeName === 'IMG';
						cmseditor.attribute.id = target.attr('id') || '';
						cmseditor.attribute.cls = arr.join(' ');
						cmseditor.attribute.title = target.attr('title') || '';

						if (cmseditor.attribute.isimage) {
							cmseditor.attribute.datawidth = target.attr('data-width');
							cmseditor.attribute.dataheight = target.attr('data-height');
							cmseditor.attribute.datasize = target.attr('data-size');
							cmseditor.attribute.alt = target.attr('alt') || '';
						}

						UPDATE('cmseditor.attribute', true);
						SET('cmseditor.window', 'attribute');
						return;

					case 'link':
						var href = '';
						var targ = '';
						var title = '';

						if (target.prop('tagName') === 'A') {
							href = target.attr('href');
							title = target.attr('title');
							targ = target.attr('target') || '_self';
						} else {
							var tmp = self.getParentElement('A');
							href = tmp.attr('href');
							title = tmp.attr('title');
							targ = tmp.attr('target') || '_self';
						}

						cmseditor.link.file = '';
						cmseditor.link.href = href;
						cmseditor.link.target = targ;
						cmseditor.link.title = (title || '').trim();

						UPDATE('cmseditor.link', true);
						SET('cmseditor.window', 'link');
						return;

					case 'edit':

						if (target.attr('contenteditable')) {
							self.getToolbar().hide();
							target.removeAttr('contentEditable');
							target.removeClass('CMS_selected');
							target = null;
							return;
						}

						if (target.hasClass('fa')) {
							// Checks if the icons have been generated
							if (typeof(cmseditor.icons) === 'string') {
								// Generate icons
								cmseditor.icons = cmseditor.icons.split(',');
								var builder = '';
								for (var i = 0, length = cmseditor.icons.length; i < length; i++)
									builder += '<div class="col-xs-1"><span class="fa fa-' + cmseditor.icons[i] + '"></span></div>';
								delete cmseditor.icons;
								$('#cmseditoricons').html(builder);
							}

							SET('cmseditor.window', 'icon');
							return;
						}

						if (target.hasClass('CMS_widget')) {
							cmseditor.widget.settings = target.find('pre').text();
							UPDATE('cmseditor.widget', true);
							SET('cmseditor.window', 'widget');
							return;
						}

						if (target.prop('tagName') === 'IMG') {

							var w = parseInt(target.attr('data-width'));
							var h = parseInt(target.attr('data-height'));

							if (isNaN(w) || isNaN(h)) {
								$('#cmseditor_inlineupload').trigger('click');
								return;
							}

							FIND('#cmseditor.crop').resize(w, h);
							cmseditor.crop.url = target.attr('data-original') || target.attr('src');
							cmseditor.crop.alt = target.attr('alt');
							cmseditor.crop.href = '';

							var parent = target.parent('a');
							if (parent.length > 0)
								cmseditor.crop.href = parent.attr('href');

							UPDATE('cmseditor.crop', true);
							SET('cmseditor.window', 'picture');
							return;
						}

						target.attr('contenteditable', true).focus();
						self.change(true);
						break;

					case 'remove':

						if (!target.hasClass('CMS_remove')) {
							target = self.getParent('CMS_remove');
							if (!target) {
								self.getToolbar().hide();
								return;
							}
						}

						target.remove();
						self.getToolbar().hide();
						self.change(true);
						break;

					case 'repeat':

						if (target.hasClass('CMS_repeat')) {
							target.after(target.clone().removeAttr('contentEditable').removeClass('CMS_selected').addClass('CMS_remove'));
						} else {
							var parent = self.getParent('CMS_repeat');
							if (parent) {
								target.removeClass('CMS_selected');
								parent.after(parent.clone().removeAttr('contentEditable').removeClass('CMS_selected').addClass('CMS_remove'));
							}
						}

						self.change(true);
						break;
				}
			});

			var index = 0;
			body.find('.CMS_widget').each(function() {
				var el = $(this);
				var id = el.attr('data-id');
				for (var i = 0, length = cmseditor.widgets2.length; i < length; i++) {
					if (cmseditor.widgets2[i].id !== id)
						continue;
					el.html('--- <span class="fa fa-plug"></span> ' + cmseditor.widgets2[i].name + ' ---<pre>' + cmseditor.settings[index].replace(/\</g, '&gt;').replace(/\>/g, '&lt;').replace(/\"/g, '&quot;') + '</pre>');
					break;
				}
				index++
			});

			self.resize(10);
			self.load();
		};

		self.load = function(type) {
			setTimeout(function() {
				var w = self.getWindow();
				if (w.$cmseditor_load)
					w.$cmseditor_load(type);
				if (w.COM)
					w.COM.emit('cmseditor.load', type);
			}, 1000);
		};

		self.resize = function(force) {
			setTimeout(function() {
				var contents = self.getContents();
				var h = navigator.userAgent.indexOf('Safari') === -1 ? contents.outerHeight() : contents.find('#cmseditorheight').offset().top;
				iframe.css({ height: h + 50 });
				width = contents.width();
				setTimeout(function() {
					FIND('form', true).forEach(FN('(component) => component.resize()'));
				}, 300);
			}, force ? 10 : 500);
		};

		self.setter = function(value, path, type) {

			// Sets the current instance of editor to global variable
			cmseditor.instance = self;

			if (value === null || value === undefined) {
				self.write('');
				return;
			}

			var options = {};
			options.body = value;
			options.template = self.options.template;

			if (!options.template) {
				self.write('');
				return;
			}

			SETTER('loading', 'show');
			AJAX('POST {0}/api/pages/preview/'.format(managerurl), options, function(response) {
				if (isError(arguments))
					return;
				self.write(response.replace('</body>', '<div id="CMS_panel"><span class="fa fa-pencil" title="@(Edit)" data-name="edit"></span><span class="fa fa-link" title="@(Change link)" data-name="link"></span><span class="fa fa-quote-left" title="@(Change attributes)" data-name="attribute"></span><span class="fa fa-copy" title="@(Duplicate)" data-name="repeat"></span></span><span class="fa fa-plug" title="@(Add widget)" data-name="widgets"></span><span class="fa fa-trash" title="@(Remove content)" data-name="remove"></span><span class="fa fa-toggle-down" title="@(Hide)" data-name="hide"></span></div></body>'));
				SETTER('loading', 'hide', 500);
			});
		};

		self.showSourceCode = function() {
			var loading = FIND('loading');
			loading.show();
			self.save(function() {
				SET('cmseditor.source', self.getSourceCode().replace(/\n[\s\t]+\n/g, '\n'), true);
				SET('cmseditor.window', 'source');
				loading.hide(500);
			}, 'sourcecode');
		};
	});

	ON('#cmseditor_widgets', function(component) {
		component.element.on('click', '.pages-editor-widget', function() {
			var el = $(this);
			var id = el.attr('data-id');
			var is = el.attr('data-template') === 'true';
			var editor = cmseditor.instance;

			component.hide();

			var target = editor.getTarget();
			if (!target.hasClass('CMS_widgets')) {
				var tmp = editor.getParent('CMS_widget', 5);
				if (!tmp)
					tmp = editor.getParent('CMS_template', 5);
				if (!tmp)
					tmp = editor.getParent('CMS_widgets', 5);
				if (!tmp)
					return;
				target = tmp;
			}

			if (!is) {
				var content = '<div class="CMS_widget CMS_remove" data-id="' + id + '">--- <span class="fa fa-plug"></span> ' + el.attr('data-name') + ' ---<pre></pre></div>';
				if (target.hasClass('CMS_widgets'))
					target.append(content);
				else
					target.after(content);
				editor.change(true);
				editor.resize();
				return;
			}

			SETTER('loading', 'show');
			AJAX('GET {0}/api/widgets/{1}/'.format(managerurl, id), function(response) {
				if (isError(arguments))
					return;
				var content = '<div class="CMS_template CMS_remove">' + response.body + '</div>';
				if (target.hasClass('CMS_widgets'))
					target.append(content);
				else
					target.after(content);
				editor.change(true);
				editor.resize();
				SETTER('loading', 'hide', 500);
			});
		});
	});

	// Editor: Picture form
	ON('#cmseditor_picture', function(component) {
		component.submit = function(hide) {

			var editor = cmseditor.instance;
			var target = editor.getTarget();
			var cropper = FIND('#cmseditor.crop');

			target.attr('alt', cmseditor.crop.alt);

			if (cmseditor.crop.href)
				target.parent('a').attr('href', cmseditor.crop.href);

			editor.change(true);

			// Is the picture changed?
			if (cropper.dirty()) {
				hide();
				return;
			}

			var data = cropper.output();
			var loading = FIND('loading');

			loading.show();

			AJAX('POST {0}/upload/base64/'.format(managerurl), { file: data }, function(response, err) {

				if (err) {
					var errmsg = $('#cmseditor_inlineupload').attr('data-error-large');
					var message = FIND('message');
					if (message)
						message.warning(errmsg);
					else
						alert(errmsg);
					loading.hide(500);
					return;
				}

				if (response) {
					setTimeout(function() {
						var size = target.attr('data-size');
						if (size) {
							target.attr('data-original', response);
							target.attr('src', response + '?s=' + size.replace('%', ''));
						} else
							target.attr('src', response);
					}, 1000);
				}

				setTimeout(hide, 1000);
				loading.hide(1500);
			});
		};
	});

	// Editor: Link form
	ON('#cmseditor_link', function(component) {
		component.submit = function(hide) {

			var editor = cmseditor.instance;
			var target = editor.getTarget();
			var link;

			if (target.prop('tagName') === 'A')
				link = target;
			else
				link = editor.getParentElement('A');

			link.attr('href', cmseditor.link.href);

			if (cmseditor.link.title)
				link.attr('title', cmseditor.link.title.trim());
			else
				link.removeAttr('title');

			if (cmseditor.link.target === '_self')
				link.removeAttr('target');
			else
				link.attr('target', cmseditor.link.target);

			if (target.data('temporary'))
				target.removeData('temporary');

			editor.change(true);
			hide();
		};

		component.cancel = function(hide) {
			var editor = cmseditor.instance;
			var target = editor.getTarget();

			if (target.data('temporary')) {
				target.removeData('temporary');
				target.replaceWith(target.html());
			}

			hide();
		};

		WATCH('cmseditor.link.file', function(path, value) {
			if (!value)
				return;
			SET('cmseditor.link.href', '/download/' + value);
			CHANGE('cmseditor.link.href', true);
		});
	});

	// Editor: Widget settings
	ON('#cmseditor_attribute', function(component) {
		component.submit = function(hide) {

			var target = cmseditor.instance.getTarget();

			if (cmseditor.attribute.title)
				target.attr('title', cmseditor.attribute.title.trim());
			else
				target.removeAttr('title');

			if (cmseditor.attribute.isimage) {
				if (cmseditor.attribute.alt)
					target.attr('alt', cmseditor.attribute.alt.trim());
				else
					target.removeAttr('alt');
			}

			if (cmseditor.attribute.id)
				target.attr('id', cmseditor.attribute.id);
			else
				target.removeAttr('id');

			// var arr = cmseditor.attribute.cls.split(' ');
			var arr = target.attr('class').split(' ');
			var cls = [];

			for (var i = 0, length = arr.length; i < length; i++) {
				if (arr[i].substring(0, 4) === 'CMS_')
					cls.push(arr[i]);
			}

			if (cmseditor.attribute.isimage) {
				if (cmseditor.attribute.datawidth)
					target.attr('data-width', cmseditor.attribute.datawidth);
				else
					target.removeAttr('data-width');

				if (cmseditor.attribute.dataheight)
					target.attr('data-width', cmseditor.attribute.dataheight);
				else
					target.removeAttr('data-width');

				if (cmseditor.attribute.datasize)
					target.attr('data-size', cmseditor.attribute.datasize + (cmseditor.attribute.datasize.lastIndexOf('%') === -1 ? '%' : ''));
				else
					target.removeAttr('data-size');
			}

			if (cmseditor.attribute.cls)
				cls.push(cmseditor.attribute.cls.trim());

			target.attr('class', cls.join(' '));
			cmseditor.instance.change(true);
			hide();
		};
	});

	// Editor: Widget settings
	ON('#cmseditor_widget', function(component) {
		component.submit = function(hide) {
			var editor = cmseditor.instance;
			var target = editor.getTarget();
			target.find('pre').text(cmseditor.widget.settings);
			editor.change(true);
			hide();
		};
	});

	// Editor: Source-code
	ON('#cmseditor_source', function(component) {
		component.submit = function(hide) {
			var editor = cmseditor.instance;
			var target = editor.getTarget();
			editor.getToolbar().hide();

			if (target) {
				target.removeAttr('contentEditable');
				target.removeClass('CMS_selected');
				target = null;
			}

			editor.doFind('#CMS').html(cmseditor.source);
			editor.resize();
			editor.change(true);
			editor.load('sourcecode');
			hide();
		};

		component.cancel = function(hide) {
			var editor = cmseditor.instance;
			editor.resize();
			editor.load('sourcecode');
			hide();
		};
	});

	function cmseditor_widgets(all) {

		if (all) {
			SET('cmseditor.widgets2', cmseditor.widgets);
			return;
		}

		var arr = [];
		cmseditor.widgets.forEach(function(item) {
			if (item.istemplate)
				arr.push(item);
		});

		SET('cmseditor.widgets2', arr);
	}

	$(document).on('click', '#cmseditoricons .fa', function() {
		SET('cmseditor.window', '');
		var target = cmseditor.instance.getTarget();
		if (!target.hasClass('fa'))
			return;
		var cls = target.attr('class');
		var arr = cls.split(' ');
		cls = '';
		for (var i = 0, length = arr.length; i < length; i++) {
			if (arr[i].substring(0, 3) !== 'fa-')
				cls += (cls ? ' ' : '') + arr[i];
		}
		cls += (cls ? ' ' : '') + $(this).attr('class').replace(/fa\s/, '');
		target.attr('class', cls);
		cmseditor.instance.change(true);
	});
</script>